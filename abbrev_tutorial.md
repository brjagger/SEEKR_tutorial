# Simulation Enabled Estimation of Kinetic Rates (SEEKR): a Multiscale Simulation Approach for Calculating Binding Kinetics

In this abbreviated version of the tutorial, you will learn how to analyze the results of a SEEKR calculation.

You will:
1. Examine the SEEKR input file
2. Visualize simulation trajectories 
3. Construct a milestoning model and calculate rates
4. Perform convergence analysis

## SEEKR Requirements

The most recent version of SEEKR can be obtained here: https://github.com/nbcrrolls/SEEKR


The abbreviated tutorial requires the following installed:
* VMD for visualization http://www.ks.uiuc.edu/Development/Download/download.cgi?PackageName=VMD
* BrownDye for BD simulations https://browndye.ucsd.edu/
* Python version 2 (2.7 or later) with the following packages (I recommend using Anaconda):
   - numpy
   - scipy
   - MDAnalysis
   - matplotlib
   - dill
   
 If you are using the virtual machine that we have distributed, everything is already installed for you!
   
   
## The SEEKR Input File

In the SEEKR tutorial directory, you will find the SEEKR input file ```bcd_aspirin_complete.seekr```.
Open this file with a text editor. This is a completed input file that was used to generate the 
data we will be working with.
Let's briefly take a look at its contents...

* The ```project details``` setion contains general information for SEEKR such as where to create the filetree, and important 
parameters related to the lengths of simulations to be run.
* The ```Ligand/receptor information``` block specifies the locations of structures that define the ligand and receptor. 
* The ```NAMD TCL``` block contains all of the information that must be passed to NAMD to run the milestoning simulations. the 
`ligrange` corresponds to the atom numbers of the aspirin ligand and
`recrange` corresponds to the atom numbers of the cyclodextrin. 
If you look in the .pdb files of the host and guest, you will see that the cyclodextrin is residues 
1 to 147 and the ligand is 20 residues (therefore 148 to 168).
* The ```Active Sites``` block is where the mielstones are defined by specifying the coordinates for the bound state, and the milestone spacing.
* The ```ligand positions``` block contains the ```reject clashes``` option which prevents milestones from being generated when there is a steric clash.
* The ```MD Parameters``` block contains all of the information required for the Molecular Dynamics portion of the calculation
   - The ```LEaP``` section details force field parameterization using Amber's LEaP package.
   -  After the leap inputs, you should see parameter specificatins for each of the 
   simulation phases of the milestoning calculation: 
      * Minimization
      * Temperature Equilibration
      * Ensemble Equilibration
      * Reversal and Forward
      * Brownian Dynamics 

Take a look at the parameters for each section...

At this point, you would now be ready to run SEEKR. For this tutorial, I have already done this for you.


## The SEEKR Filetree 

* The output from running SEEKR is a directory called ```bcd_tutorial_aspirin```.

* The directory contains a filetree that SEEKR constructed. Inside, you will see several folders that begin with the word 'anchor' and a folder that is called 'b_surface'. Additionally, you will see a milestones.xml file, which the program uses to represent the milestone surfaces, and will be used for analysis in the end. There are also several '.pkl' files. The '.pkl' files are python "pickle" files that allow subsequent runs of seekr.py to be completed more quickly and easily, but you will never interact with them.

* The directories that begin with "anchor" are designed to be informative. The format looks like: "anchor_A_B_C_D_E_F_G" The numbers correspond to:

   - A: The index of the milestone (can be positional or rotational)
   - B: The index of the positional milestone
   - C: The site ID for multiple binding locations on the receptor
   - D: The X-coordinate of the anchor (location where the center-of-mass of the ligand was placed)
   - E: The Y-coordinate of the anchor (location where the center-of-mass of the ligand was placed)
   - F: The Z-coordinate of the anchor (location where the center-of-mass of the ligand was placed)
   - G: The index of the rotational milestone. (Until this feature is fully developed, it is likely only to be zero.)


* Look inside the directories that begin with 'anchor_4'. In this 
directory, you will see at one subdirectory "md". Look inside the "md" subdirectory. You 
will see the directories: "building", "min", "temp_equil", "ens_equil", and 
"fwd_rev" directories. You'll also see a "holo_wet.pdb" structure. Take a look 
at the structure in VMD and verify that it looks OK.

* Look inside the "building" directory. Inside will be a LEAP file used to 
prepare a PRMTOP and INPCRD file, as well as LEAP output and a PDB file 
generated by LEAP. The LEAP output file can be useful for debugging problems 
running LEAP in other projects.

* Back up into the "md" folder. The other directories will be useful for running 
preparations of this particular milestone for simulation.

* Now back up two directories and enter the "b_surface" directory. Inside here 
are a number of files that will be used for BD simulations starting at this 
anchor.

## Running MD and BD Simulations ##

* We do not have time to actually run the MD and BD simulations for this tutorial, as they can take hours to days to complete. 
However, I have provided you with all the data so that we can do some analysis. 

## Visualizing MD Simulation Results ##

In the project directory, navigate to ```anchor_4*``` again and then into the 
"md" directory. From here you can visualize the results of the ensemble equilibration MD simulations by loading 
parameter file located in the building directory and any of the .dcd trajectories located in the ens_equil 
directory in VMD.

```vmd ../building/holo.parm7 sample_traj.dcd```

**Notice how the ligand was restrained at the appropriate distance for the corresponding milestone.**

In the fwd_rev directory, you will see some .out files that contain all of the milestone transition events that occured in the simulation. These are pulled from the NAMD output and placed in this file for simplicity.


## Calculating Kinetic Parameters ##

To analyze our milestoning simulations, SEEKR possesses a script called `analyze_conv.py`

This script can:

- calculate k_on and k_off as well as error estimates
- calculate a binding free energy profile
- Perform convergence analysis: 
   * plot calculated rate constants vs. reversal number
   * plot transition counts (in and out) per milestone vs. reversal number 
   * plot incubation time per milestone vs. reversal number
   
analze_conv.py requires a few basic inputs (with additional options for the various calculation types):
   
   - a milestones.xml file which contains basic information about each milestone (name, path, milestone distance, etc.)
   - output files from MD and BD simulations to parse for transition events
   - definition of which milestones correspond to the bound state

1. Execute ``` python analyze_conv.py -h``` for more information about useage as well as additional arguments.

The filetree `bcd_tutorial_aspirin` has all of the data we need to calculate the kinetic rate constants of interest.

**Calculate the On Rate**

2. Inside the bcd_tutorial_aspirin directory, execute

```python PATH/TO/SEEKR/bin/analyze_conv.py -m milestones.xml -b 0,9 --on -v ```

This calculates the on rate using both milestone 0 and 9 as bound states, aka sink states.

SEEKR will go in to each anchor and extract the transition statistics. Then it will create a transition probability matrix and 
incubation time vector that can be used to calculate the on rate. You will see a lot of output because of the addition of the verbose flag, take some time to inspect this.

**Calculating the Off Rate**

3. The off rate can be calculated in exacytly the same way using the --off flag: 

```python PATH/TO/SEEKR/bin/analyze.py -m milestones.xml -b 0,9 --off ```

4. Similarly, we can calculate a **binding free energy profile**:

```python PATH/TO/SEEKR/bin/analyze_conv.py -m milestones.xml -b 0 --free_energy ```


## SEEEKR Convergence Analysis

SEEKR now has the capability to perform basic convergence analysis/estimates.

5. First lets look at the convergence of the **on and off rates**.
execute :

```python PATH/TO/SEEKR/bin/analyze_conv.py -m milestones.xml -b 0,9 --on --conv_filename on_conv.txt --conv_stride 100```

This will calculate the on rate with an interval of 100 reversals.

6. We can do the same for the off rate:

```python PATH/TO/SEEKR/bin/analyze_conv.py -m milestones.xml -b 0,9 --off --conv_filename off_conv.txt --conv_stride 100```


It is often informative to plot the radius vs. delta G to get a feel for the depth of the free energy well. 


7. SEEKR can also provide **convergence estimates on a per milestone basis**. Execute:
 

```python PATH/TO/SEEKR/bin/analyze_conv.py -m milestones.xml -b 0,9 --milestone_conv --conv_stride 100 --plt_name Aspirin_Q4MD```

8. Two .png figures will be saved, one that plots the incubation time of each milestone and one that plots the transition counts between all milestones. View these figures with your favorite graphics program, for example:

```display Aspirin_Q4MD_Incubation_Time_Convergence.png```

These plots should give a general idea of which milestones have been sufficiently sampled, which are potentially undersampled, 
and which contribute most to the calculated rate constants.

analyze_conv.py also writes out .pkl files of the raw data and the figures so that additional postprocessing may be performed as desired.


## Conclusions
 At this point you should have a feel for the basic functionalities included in SEEKR. The software is always growing, adding new analyses as well as new milestoning functionalities. Be sure to check out the SEEKR GitHub to stay up do date with the latest additions: https://github.com/nbcrrolls/SEEKR.
 
 
 Tutorial written by: 
 
 Benjamin Jagger 
 bjagger@ucsd.edu
 Graduate Student Amaro and McCammon Groups
